<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Optimization - AdOptimizer AI</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="{{ url_for('static', filename='script.js') }}"></script>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <a href="/" class="navbar-brand">AdOptimizer AI</a>
        <ul class="navbar-menu">
            <li><a href="javascript:void(0)" onclick="goHome()">Home</a></li>
            <li><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
            <li><a href="{{ url_for('ml_insights') }}">ML Insights</a></li>
            <li><a href="{{ url_for('optimization') }}">Optimization</a></li>
            <li><a href="{{ url_for('contact_page') }}">Contact</a></li>
            <li><button class="btn-logout" onclick="logout()">Logout</button></li>
        </ul>
    </nav>
    
    <div class="container-full">
        <div class="container">
            <h1>Campaign Optimization Settings</h1>
            <p>Configure automatic optimization rules and let AI improve your campaign performance.</p>
            
            <!-- Toggle Settings -->
            <div class="chart-card" style="margin-bottom: 2rem;">
                <h3>Automation Settings</h3>
                
                <div class="toggle-container">
                    <span class="toggle-label">Auto-optimize budget allocation</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="autoBudget" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                
                <div class="toggle-container">
                    <span class="toggle-label">Enable A/B test learning</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="autoABTest" checked>
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
            
            <!-- Slider Controls -->
            <div class="chart-card" style="margin-bottom: 2rem;">
                <h3>Optimization Parameters</h3>
                
                <div class="slider-group">
                    <label for="budgetRange">
                        Maximum Budget Range: 
                        <span class="slider-value" id="budgetValue">$5,000.00</span>
                    </label>
                    <input type="range" id="budgetRange" min="1000" max="50000" value="5000" step="100">
                </div>
                
                <div class="slider-group">
                    <label for="confidence">
                        Confidence Threshold: 
                        <span class="slider-value" id="confidenceValue">75%</span>
                    </label>
                    <input type="range" id="confidence" min="50" max="99" value="75" step="1">
                </div>
                
                <div class="slider-group">
                    <label for="frequency">
                        Optimization Frequency: 
                        <span class="slider-value" id="frequencyValue">daily</span>
                    </label>
                    <select id="frequency" class="form-input">
                        <option value="hourly">Every Hour</option>
                        <option value="daily" selected>Daily</option>
                        <option value="weekly">Weekly</option>
                    </select>
                </div>
            </div>
            
            <!-- Apply Button -->
            <div style="text-align: center; margin-bottom: 2rem;">
                <button id="runOptimization" class="btn-success" style="font-size: 1.125rem; padding: 1rem 3rem;">
                    Apply Optimization
                </button>
            </div>
            
            <div id="optimizationSuccess" class="success-message"></div>
            <div id="optimizationError" class="error-message"></div>
            <div id="optimizationLoading" class="loading">
                <div class="spinner"></div>
                <p>Applying optimization settings...</p>
            </div>
            
            <!-- Results Display -->
            <div id="optimizationResults">
                <div class="table-container">
                    <h3>Optimization Results</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Campaign</th>
                                <th>Action</th>
                                <th>Confidence</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="optimizationTableBody">
                            <tr>
                                <td colspan="4" style="text-align: center; color: var(--dark-gray);">
                                    Configure your optimization settings above and click "Apply Optimization" to see results.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Additional standalone JavaScript for Optimization page
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is logged in
            const token = localStorage.getItem('access_token');
            if (!token) {
                window.location.href = '/login';
                return;
            }

            // Initialize slider values
            const budgetSlider = document.getElementById('budgetRange');
            const confidenceSlider = document.getElementById('confidence');
            
            if (budgetSlider) {
                budgetSlider.addEventListener('input', function() {
                    document.getElementById('budgetValue').textContent = formatCurrency(parseFloat(this.value));
                });
                // Set initial value
                document.getElementById('budgetValue').textContent = formatCurrency(parseFloat(budgetSlider.value));
            }

            if (confidenceSlider) {
                confidenceSlider.addEventListener('input', function() {
                    document.getElementById('confidenceValue').textContent = this.value + '%';
                });
                // Set initial value
                document.getElementById('confidenceValue').textContent = confidenceSlider.value + '%';
            }

            const optimizeButton = document.getElementById('runOptimization');
            if (optimizeButton) {
                optimizeButton.addEventListener('click', runOptimization);
            }
        });

       async function runOptimization() {
    const budgetRange = parseFloat(document.getElementById('budgetRange').value) || 5000;
    const confidence = parseFloat(document.getElementById('confidence').value) || 75;
    const frequency = document.getElementById('frequency').value || 'daily';
    const autoBudget = document.getElementById('autoBudget').checked;
    const autoABTest = document.getElementById('autoABTest').checked;

    const data = {
        budget_range: budgetRange,
        confidence_threshold: confidence / 100, // Convert percentage to decimal
        frequency: frequency,
        auto_budget: autoBudget,
        auto_ab_test: autoABTest
    };

    try {
        toggleLoading('optimizationLoading', true);
        const response = await applyOptimization(data);

        if (response.status === 'success') {
            displayOptimizationResults(response.optimization_results);
            showSuccess('optimizationSuccess', 'Optimization completed successfully!');
        } else {
            showError('optimizationError', response.message || 'Optimization failed');
        }
    } catch (error) {
        console.error('Optimization error:', error);
        showError('optimizationError', 'Failed to run optimization. Please check if the server is running.');
    } finally {
        toggleLoading('optimizationLoading', false);
    }
}

        function displayOptimizationResults(results) {
            const tableBody = document.getElementById('optimizationTableBody');
            
            if (tableBody) {
                let html = '';
                
                if (results && results.length > 0) {
                    results.forEach(result => {
                        const confidenceClass = result.confidence > 0.8 ? 'high' : result.confidence > 0.6 ? 'medium' : 'low';
                        
                        html += `
                            <tr>
                                <td>${result.campaign || 'Unnamed Campaign'}</td>
                                <td>${result.action || 'No action required'}</td>
                                <td>${Math.round(result.confidence * 100)}%</td>
                                <td><span class="recommendation-badge badge-${confidenceClass}">${confidenceClass.toUpperCase()}</span></td>
                            </tr>
                        `;
                    });
                } else {
                    // Fallback to sample data
                    const sampleResults = [
                        { campaign: 'Google Ads Q4', action: 'Increase budget by 15%', confidence: 0.85 },
                        { campaign: 'Facebook Prospecting', action: 'Decrease budget by 20%', confidence: 0.72 },
                        { campaign: 'Instagram Story Ads', action: 'Maintain current budget', confidence: 0.63 }
                    ];
                    
                    sampleResults.forEach(result => {
                        const confidenceClass = result.confidence > 0.8 ? 'high' : result.confidence > 0.6 ? 'medium' : 'low';
                        
                        html += `
                            <tr>
                                <td>${result.campaign}</td>
                                <td>${result.action}</td>
                                <td>${Math.round(result.confidence * 100)}%</td>
                                <td><span class="recommendation-badge badge-${confidenceClass}">${confidenceClass.toUpperCase()}</span></td>
                            </tr>
                        `;
                    });
                }
                
                tableBody.innerHTML = html;
            }
        }

        // Helper functions
        function formatCurrency(num) {
            return '$' + num.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
        }

        function showLoading(elementId, show) {
            const element = document.getElementById(elementId);
            if (element) {
                element.style.display = show ? 'block' : 'none';
            }
        }

        function showMessage(elementId, message) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = message;
                element.style.display = 'block';
            }
        }

        function hideMessage(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.style.display = 'none';
            }
        }

        // API call helper
        async function apiCall(endpoint, method = 'GET', data = null) {
            const options = {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                }
            };

            if (data) {
                options.body = JSON.stringify(data);
            }

            try {
                const response = await fetch(`/api${endpoint}`, options);
                
                if (response.status === 401) {
                    localStorage.removeItem('access_token');
                    window.location.href = '/login';
                    throw new Error('Authentication failed');
                }

                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }
    </script>
</body>
</html>